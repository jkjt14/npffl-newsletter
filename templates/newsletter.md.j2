{# ============================
  Narrative-first NPFFL newsletter
  Inputs expected (lenient):
  - title                (str)
  - week_label           (str / "01")
  - timezone             (str)
  - standings_rows       (list of {id, name, pf, vp})
  - team_efficiency      (list of {franchise_id, total_pts, total_sal, ppk})
  - top_performers       (list of {player, pos, team, pts, franchise_ids})
  - top_values           (list of {player, pos, team, pts, salary, franchise_id, ppk})
  - top_busts            (list of similar)
  - pool_nfl_summary     (dict you assemble; see notes)
  - survivor_summary     (dict you assemble; see notes)
  - franchise_names      (id->name map)
  - manager_traits       (name->short quip), optional
  - roasts               (dict with strings: lead, standings, headliners, values, busts, efficiency, pickem, survivor, fraud_watch, jail, villain)
============================ #}

# {{ title }}
Week {{ week_label }} · {{ timezone }}

{# ===== Lead ===== #}
{{ roasts.lead | default("The scoreboard lit up, some wallets cried, and a few of you discovered new and inventive ways to waste a salary cap.") }}

{# ===== Standings ===== #}
## Standings (Week-to-date)

{# Narrative first #}
{% set standings_sorted = (standings_rows or []) | sort(attribute="pf", reverse=True) %}
{% if standings_sorted %}
  {% set top = standings_sorted[0] %}
  {% set bottom = standings_sorted | last %}
  {{ roasts.standings | default(top.name ~ " strutted in like they owned the joint with " ~ "%.2f"|format(top.pf) ~
    " — while " ~ bottom.name ~ " posted " ~ "%.2f"|format(bottom.pf) ~
    ", the fantasy equivalent of forgetting your pants at work.") }}
{% else %}
  _No standings available this week._
{% endif %}

| Team | PF | VP |
|---|---:|---:|
{% for r in standings_sorted %}
| {{ r.name }} | {{ "%.2f"|format(r.pf) }} | {{ r.vp|default(0) }} |
{% endfor %}

{# ===== Weekly Scores ===== #}
## Weekly Scores (Starter Lineups)

{% if standings_sorted %}
  {% set min_pf = (standings_sorted | last).pf %}
  {% set max_pf = (standings_sorted | first).pf %}
  Range {{ "%.2f"|format(min_pf) }} → {{ "%.2f"|format(max_pf) }}. The middle was a shoulder-to-shoulder mosh pit — every slot mattered.
{% endif %}

| Team | Score |
|---|---:|
{% for r in standings_sorted %}
| {{ r.name }} | {{ "%.2f"|format(r.pf) }} |
{% endfor %}

{# ===== Headliners ===== #}
## Headliners

{% if top_performers and top_performers|length > 0 %}
  {% set top = top_performers[0] %}
  {% set mule_cnt = top.franchise_ids|length %}
  {{ roasts.headliners | default(
    top.player ~ " turned the week into a group project and did all the work — " ~ mule_cnt ~ " franchises rode that wave. " ~
    "If you didn’t hitch your wagon, you were pushing it uphill."
  ) }}

  _Other explosions:_
  {% for p in top_performers[1:5] %}
  - {{ p.player }} dropped {{ "%.2f"|format(p.pts) }} ({{ p.team }}, {{ p.pos }})
  {% endfor %}

  | Player | Pos | NFL | Pts | Managers |
  |---|:--:|:--:|---:|---|
  {% for p in top_performers %}
    {% set mgrs = (p.franchise_ids or []) | map('string') | list %}
    {% set mgr_names = mgrs | map('trim') | list %}
    {% set names = [] %}
    {% for fid in p.franchise_ids %}
      {% set _ = names.append(franchise_names.get(fid, fid)) %}
    {% endfor %}
  | {{ p.player }} | {{ p.pos }} | {{ p.team }} | {{ "%.2f"|format(p.pts) }} | {{ names|join(", ") }}
  {% endfor %}
{% else %}
  _Nobody popped. That’s somehow worse._
{% endif %}

{# ===== Value vs Busts ===== #}
## Value vs. Busts

{{ roasts.values | default("The receipts are in. Some of you found steak at hot-dog prices; others paid boutique rates for gas-station sushi.") }}

### Biggest Steals (we won’t teach you how the sausage is priced)
{% if top_values and top_values|length > 0 %}
| Player | Pts | Salary | Team | Pos | Manager |
|---|---:|---:|:--:|:--:|---|
{% for r in top_values %}
  {% set mgr = franchise_names.get(r.franchise_id, r.franchise_id) %}
  | {{ r.player }} | {{ "%.2f"|format(r.pts) }} | ${{ (r.salary or 0) | int | string | replace(",", "") | int | string | format }} | {{ r.team }} | {{ r.pos }} | {{ mgr }}
{% endfor %}
{% else %}
_No value standouts this week. Everyone shopped at the same dull store._
{% endif %}

### Overpriced Misfires
{% if top_busts and top_busts|length > 0 %}
| Player | Pts | Salary | Team | Pos | Manager |
|---|---:|---:|:--:|:--:|---|
{% for r in top_busts %}
  {% set mgr = franchise_names.get(r.franchise_id, r.franchise_id) %}
  | {{ r.player }} | {{ "%.2f"|format(r.pts) }} | ${{ (r.salary or 0) | int }} | {{ r.team }} | {{ r.pos }} | {{ mgr }}
{% endfor %}
{% else %}
_No notable misfires… which is suspicious._
{% endif %}

{# ===== Efficiency Buckets ===== #}
## Power Rankings — Efficiency Vibes

{% set eff = (team_efficiency or []) %}
{% if eff and eff|length > 0 %}
  {% set sorted_eff = eff | sort(attribute='ppk', reverse=True) %}
  {% set overlords = sorted_eff[:3] %}
  {% set dumpster = sorted_eff[-3:] %}
  {% set middle = sorted_eff[3:-3] %}

  {{ roasts.efficiency | default("Overlords flexed. Middle Management clocked in. Dumpster Division lit money on fire.") }}

  **Overlords**
  {% for r in overlords %}
    {% set nm = franchise_names.get(r.franchise_id, r.franchise_id) %}
  - {{ nm }} — {{ "%.2f"|format(r.total_pts) }} pts on ${{ r.total_sal|int }} cap; ruthless.
  {% endfor %}

  **Middle Management**
  {% for r in middle %}
    {% set nm = franchise_names.get(r.franchise_id, r.franchise_id) %}
  - {{ nm }} — Present. That’s it. Just… present.
  {% endfor %}

  **Dumpster Division**
  {% for r in dumpster %}
    {% set nm = franchise_names.get(r.franchise_id, r.franchise_id) %}
  - {{ nm }} — brought a butter knife to a gunfight.
  {% endfor %}
{% else %}
  _Efficiency board refuses to snitch this week._
{% endif %}

{# ===== Confidence Pick’em ===== #}
## Confidence Pick’em — Drama

{{ roasts.pickem | default("Some of you rode chalk; some of you tried parkour without a helmet.") }}

{% set pick = pool_nfl_summary or {} %}
{% if pick %}
- **Boldest hit:** {{ pick.boldest.manager }} jumped on {{ pick.boldest.team }} with {{ pick.boldest.conf }} points — not for the faint-hearted.
- **Faceplant of the week:** {{ pick.faceplant.manager }} welded {{ pick.faceplant.conf }} points to {{ pick.faceplant.team }}. Didn’t end well.
- **Most basic:** {{ pick.most_common.team }} was the comfort food pick ({{ pick.most_common.count }} entries).

{% if pick.no_picks and pick.no_picks|length > 0 %}
- **No-pick parade:** {{ pick.no_picks | join(", ") }} — it’s called “Confidence,” not “Nap Time.”
{% endif %}

| Team | Top-3 Confidence |
|---|---|
{% for row in pick.top3 or [] %}
| {{ row.manager }} | {{ row.line }} |
{% endfor %}

{% else %}
_No pick’em data worth roasting._
{% endif %}

{# ===== Survivor ===== #}
## Survivor — Walk of Shame Watch

{{ roasts.survivor | default("Some of you lived; some of you learned. A few of you didn’t even show up.") }}

{% set sv = survivor_summary or {} %}
{% if sv %}
{% if sv.eliminated and sv.eliminated|length > 0 %}
- **Eliminated:** {{ sv.eliminated | join(", ") }}
{% endif %}
{% if sv.no_picks and sv.no_picks|length > 0 %}
- **Didn’t play:** {{ sv.no_picks | join(", ") }}
{% endif %}
- **Boldest lifeline:** {{ sv.boldest.manager }} rolled with {{ sv.boldest.team }} — spicy.
- **Consensus blanket:** {{ sv.most_common.team }} ({{ sv.most_common.count }} entries).

| Team | Pick |
|---|---|
{% for r in sv.rows or [] %}
| {{ r.manager }} | {{ r.pick or "—" }} |
{% endfor %}
{% else %}
_No Survivor receipts this week._
{% endif %}

{# ===== Rotating Segments ===== #}
## Fraud Watch 🔥
{{ roasts.fraud_watch | default("Looking rich on the scoreboard, hemorrhaging cap under the hood. You know who you are.") }}

## DFS Jail 🚔
{{ roasts.jail | default("Padded cell reserved for anyone who started a zero. Community service: rewatch the red zone channel with captions on.") }}

## League Villain 🗡️
{{ roasts.villain | default("Celebrating a win by less than a point while someone else screams at a stat correction is an ancient NPFFL tradition.") }}

---

_Generated automatically. Tables are receipts; the words are the punchlines._
